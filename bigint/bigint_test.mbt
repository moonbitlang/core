// Copyright 2024 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

fn check_len(a : BigInt) -> Result[Unit, String] {
  if a.is_zero() {
    return Ok(())
  }
  @assertion.assert_ne(a.limbs[a.len - 1], 0)?
  for i = a.len; i < a.limbs.length(); i = i + 1 {
    @assertion.assert_eq(a.limbs[i], 0)?
  } else {
    Ok(())
  }
}

test "neg" {
  let a = from_int64(123456789012345678L)
  let b = -a
  inspect(b.to_string(), content="-123456789012345678")?
  check_len(b)?
  let a = from_string(
    "123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  let b = -a
  inspect(
    b.to_string(),
    content="-123456789012345678123456789012345678123456789012345678123456789012345678",
  )?
  check_len(b)?
  let a = from_string(
    "-123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  let b = -a
  inspect(
    b.to_string(),
    content="123456789012345678123456789012345678123456789012345678123456789012345678",
  )?
  check_len(b)?
}

test "add" {
  let a = from_int64(123456789012345678L)
  let b = from_int64(987654321098765432L)
  let c = a + b
  inspect(c.to_string(), content="1111111110111111110")?
  check_len(c)?
  let a = from_string("123456789012345678123456789012345678")
  let b = from_string("9876543210987654329876543210987654321241243")
  let c = a + b
  check_len(c)?
  inspect(c.to_string(), content="9876543334444443342222221334444443333586921")?
  let a = from_string(
    "-345678987654356798765467898765456789098764567890987655678",
  )
  let b = from_string("76678908909876567890987656789098789")
  let c = a + b
  check_len(c)?
  inspect(
    c.to_string(),
    content="-345678987654356798765391219856546912530873580234198556889",
  )?
  let a = from_string(
    "-123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  let b = from_string(
    "-5467890987656789098765678909876789098767098767890987657890987689",
  )
  let c = a + b
  check_len(c)?
  inspect(
    c.to_string(),
    content="-123456794480236665780245887778024588000245887779444446014444446903333367",
  )?
  let a = from_string(
    "123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  let b = from_string(
    "-5467890987656789098765678909876789098767098767890987657890987689",
  )
  let c = a + b
  check_len(c)?
  inspect(
    c.to_string(),
    content="123456783544454690466667690246666768246667690245246910232469131121357989",
  )?
  let a = from_string("123456789012345678123456789012345678123456789")
  let b = from_string(
    "98765432109876543298765432109876543298765432112341241213125125",
  )
  let c = a + b
  let d = b + a
  check_len(c)?
  inspect(
    c.to_string(),
    content="98765432109876543422222221122222221422222221124686919336581914",
  )?
  check_len(d)?
  inspect(
    d.to_string(),
    content="98765432109876543422222221122222221422222221124686919336581914",
  )?
  let a = from_string("1")
  let b = from_string("1")
  let c = a + b
  check_len(c)?
  inspect(c.to_string(), content="2")?
}

test "sub" {
  let a = from_int64(987654321098765432L)
  let b = from_int64(123456789012345678L)
  let c = a - b
  check_len(c)?
  inspect(c.to_string(), content="864197532086419754")?
  let c = b - a
  check_len(c)?
  inspect(c.to_string(), content="-864197532086419754")?
  let a = from_string("987654321098765432987654321098765432")
  let b = from_string("123456789012345678123456789012345678")
  let c = a - b
  check_len(c)?
  inspect(c.to_string(), content="864197532086419754864197532086419754")?
  let c = b - a
  check_len(c)?
  inspect(c.to_string(), content="-864197532086419754864197532086419754")?
  let a = from_string("-123456789012345678123456789012345678")
  let b = from_string("-987654321098765432987654321098765432")
  let c = a - b
  check_len(c)?
  inspect(c.to_string(), content="864197532086419754864197532086419754")?
  let c = b - a
  check_len(c)?
  inspect(c.to_string(), content="-864197532086419754864197532086419754")?
  let a = from_string("123456789012345678123456789012345678233")
  let b = from_string("-987654321098765432987654321098765432")
  let c = a - b
  check_len(c)?
  inspect(c.to_string(), content="124444443333444443556444443333444443665")?
  let a = from_string("-123456789012345678123456789012345678233")
  let b = from_string("987654321098765432987654321098765432")
  let c = a - b
  check_len(c)?
  inspect(c.to_string(), content="-124444443333444443556444443333444443665")?
  let a = from_string("123456789012345678123456789012345678233")
  let b = from_string("987")
  let c = a - b
  check_len(c)?
  inspect(c.to_string(), content="123456789012345678123456789012345677246")?
  let a = from_int64(
    2L * radix + 3L * radix * radix + 3L * radix * radix * radix,
  )
  let b = from_int64(
    1L * radix + 2L * radix * radix + 3L * radix * radix * radix,
  )
  let c = a - b
  check_len(c)?
  inspect(c.to_string(), content="4295032832")?
}

test "mul" {
  let a = from_int64(987654321098765432L)
  let b = from_int64(123456789012345678L)
  let c = a * b
  check_len(c)?
  inspect(c.to_string(), content="121932631137021794322511812221002896")?
  let b = from_int(0)
  let c = a * b
  check_len(c)?
  inspect(c.to_string(), content="0")?
  let a = from_string("987654321098765432987654321098765432")
  let b = from_string("123456789012345678123456789012345678")
  let c = a * b
  check_len(c)?
  inspect(
    c.to_string(),
    content="121932631137021794566377074495046484766956255579027586322511812221002896",
  )?
  let a = from_string(
    "-123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  let b = from_string(
    "5467890987656789098765678909876789098767098767890987657890987689",
  )
  let c = a * b
  check_len(c)?
  inspect(
    c.to_string(),
    content="-675048264005650638331575538351330675368295268968297112032725993817064025468035871811413387811508597465733350774788866848766914110358142",
  )?
  let a = from_string(
    "123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  let b = from_string(
    "123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  let c = a * b
  check_len(c)?
  inspect(
    c.to_string(),
    content="15241578753238836558451457271757357101661335790275877644871214308794398188081092827312918731290971345831439274500849864349959817710728382868480360920606901387000904130485419905521447340363938424041990550242456942562533760120975461083076969999493979603620179878012498124163389756531016644691358056296296328691358056296296328691358056296296328691358056296296328691358056296296328691358056296296328691358056296296328691358056296296328676116477543057492132906599024538971589696720506020451046486841987501930503276963468983409960067084950464889416857206431946368873647327913427848330437449394909327787227570876390807244017692357872286700807813839353766157597935320835245614388056802316725071178178283798204527968299765279684",
  )?
  let a = from_string(
    "123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  let b = from_string(
    "1234567890123456781234567890123456781234567890123456712345678901234567812345678901234567812345678901234567123456789012345678123456789012345678123456789012345671234567890123456781234567890123456781234567890123456778123456789012345678123456789012345677812345678901234567812345678901234567",
  )
  let c = a * b
  check_len(c)?
  inspect(
    c.to_string(),
    content="152415787532388365584514572717573571016613357902758767943911109891785022264898961743637076585886813595489045858864333485751589068742852004272132278621370522791825008396569425417257107181754610622689205966939795827737216965321140148280426843839658668785227943677793100839548931529644952793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793580330296296378793427914508763990427995815723578805222563716938393620025636419186404593771315431334552741716994443482700889747721465962810627204511587444292106661301708925773586968571933726870961536473148541685756104374363356500551056363364975156230513153486456637710008352386618503277954031398766651426",
  )?
}

test "div" {
  let a = from_int64(987654321098765432L)
  let b = from_int64(123456789012345678L)
  let c = a / b
  check_len(c)?
  inspect(c.to_string(), content="8")?
  let c = a % b
  check_len(c)?
  inspect(c.to_string(), content="9000000008")?
  let a = from_string("987654321098765432987654321098765432")
  let b = from_string("123456789012345678123456789012345678")
  let c = a / b
  check_len(c)?
  inspect(c.to_string(), content="8")?
  let c = a % b
  check_len(c)?
  inspect(c.to_string(), content="9000000008000000009000000008")?
  let a = from_string(
    "-123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  let b = from_string(
    "-5467890987656789098765678909876789098767098767890987657890987689",
  )
  let c = a / b
  check_len(c)?
  inspect(c.to_string(), content="22578502")?
  let c = a % b
  check_len(c)?
  inspect(
    c.to_string(),
    content="1411754890143397710214334775703365651947321477507789807694283800",
  )?
  let a = from_string(
    "12421645375698213532453474567345623538756734578959876125298763582362",
  )
  let b = from_string(
    "-5467890987656789098765678909876789098767098767890987657890987689",
  )
  let c = a / b
  check_len(c)?
  inspect(c.to_string(), content="-2272")?
  let c = a % b
  check_len(c)?
  inspect(
    c.to_string(),
    content="-1402948258011299942147915894441293642113821688447833429560447046",
  )?
  let a = from_string(
    "559480073748030317374803031737502937374948313029373748143063751326169",
  )
  let b = from_string(
    "5467890987656789098765678909876789098767098767890987657890987689",
  )
  let c = a / b
  check_len(c)?
  inspect(c.to_string(), content="102321")?
  let c = a % b
  check_len(c)?
  inspect(c.to_string(), content="0")?
  let c = b / a
  check_len(c)?
  inspect(c.to_string(), content="0")?
  let a = from_string(
    "-123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  let b = from_string(
    "98765432109876543298765432109876543298765432112341241213125125",
  )
  let c = a / b
  check_len(c)?
  inspect(c.to_string(), content="-1249999989")?
  let c = a % b
  check_len(c)?
  inspect(
    c.to_string(),
    content="38580247791358024838580247791358024841661120157195963893277947",
  )?
  let b = from_string(
    "123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  let c = a / b
  check_len(c)?
  inspect(c.to_string(), content="-1")?
  let c = a % b
  check_len(c)?
  inspect(c.to_string(), content="0")?
  let b = from_int(42)
  let c = a / b
  check_len(c)?
  inspect(
    c.to_string(),
    content="-2939447357436801860082304500293944717225161643151087574368018786008231",
  )?
  let c = a % b
  check_len(c)?
  inspect(c.to_string(), content="24")?
  let a = from_int64(radix * 2L)
  let b = from_int(3)
  let c = a / b
  check_len(c)?
  inspect(c.to_string(), content="43690")?
  let c = a % b
  check_len(c)?
  inspect(c.to_string(), content="2")?
  let a = from_string(
    "192840512535448761530339373212972361809285001825938158026158292411480026580386667968523131569543343891463401449181505398836",
  )
  let b = from_string("53114991887765067119604462397623222751521283658033792")
  let c = a / b
  check_len(c)?
  inspect(
    c.to_string(),
    content="3630623025283172274355511610456320508397929760764978568884844414130904",
  )?
  let a = from_string("65535232222222222222222222222")
  let b = from_string("1")
  let c = a / b
  check_len(c)?
  inspect(c.to_string(), content="65535232222222222222222222222")?
  let c = a % b
  check_len(c)?
  inspect(c.to_string(), content="0")?
}

test "lsl" {
  let a = from_int64(1234567890123456789L)
  let b = a.lsl(1)
  check_len(b)?
  inspect(b.to_string(), content="2469135780246913578")?
  let c = a.lsl(64)
  check_len(c)?
  inspect(c.to_string(), content="22773757910726981402256170801141121024")?
  let a = make_zero()
  let b = a.lsl(1)
  check_len(b)?
  inspect(b.to_string(), content="0")?
}

test "lsr" {
  let a = from_int64(1234567890123456789L)
  let b = a.lsr(1)
  check_len(b)?
  inspect(b.to_string(), content="617283945061728394")?
  let c = a.lsr(64)
  check_len(c)?
  inspect(c.to_string(), content="0")?
  let a = from_int64(radix * radix / 2L)
  let b = a.lsr(radix_bit_len * 2)
  check_len(b)?
  inspect(b.to_string(), content="0")?
}

test "decimal_string" {
  let a = from_string("0")
  check_len(a)?
  inspect(a.to_string(), content="0")?
  let a = from_string("123")
  check_len(a)?
  inspect(a.to_string(), content="123")?
  @assertion.assert_eq(a, from_int64(123L))?
  let a = from_string("1234567890123456789")
  check_len(a)?
  inspect(a.to_string(), content="1234567890123456789")?
  let b = from_string("-1234567890")
  check_len(b)?
  inspect(b.to_string(), content="-1234567890")?
  @assertion.assert_eq(a, from_int64(1234567890123456789L))?
  let str = "12345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812"
  let a = from_string(str)
  check_len(a)?
  inspect(a.to_string(), content=str)?
  let a = from_int64(1234567890123456789L)
  check_len(a)?
  inspect(a.to_string(), content="1234567890123456789")?
  let b = from_int64(-1234567890L)
  check_len(b)?
  inspect(b.to_string(), content="-1234567890")?
}

test "from_int" {
  let a = from_int(1234567899)
  check_len(a)?
  inspect(a.to_string(), content="1234567899")?
  let b = from_int(-1234567890)
  check_len(b)?
  inspect(b.to_string(), content="-1234567890")?
}

test "compare" {
  let a = from_int64(1234567890123456789L)
  let b = from_int64(-1234567890123456789L)
  inspect(a.compare(b), content="1")?
  inspect(b.compare(a), content="-1")?
  let a = -a
  let b = from_int64(-1234567890123456788L)
  @assertion.assert_true(a.compare(b) < 0)?
  @assertion.assert_true(b.compare(a) > 0)?
  let a = from_int64(-1234567890123456789L)
  let b = from_int64(-1234569L)
  @assertion.assert_true(a.compare(b) < 0)?
  @assertion.assert_true(b.compare(a) > 0)?
}

test "from_hex" {
  // Check zero
  let a = from_hex("0")
  check_len(a)?
  inspect(a.to_string(), content="0")?

  // Test positive number
  let a = from_hex("1")
  check_len(a)?
  inspect(a.to_string(), content="1")?

  // Test negative number
  let a = from_hex("-F")
  check_len(a)?
  inspect(a.to_string(), content="-15")?
  let a = from_hex("-a")
  check_len(a)?
  inspect(a.to_string(), content="-10")?

  // Test large positive number
  let a = from_hex("112210F47DE98115")
  check_len(a)?
  inspect(a.to_string(), content="1234567890123456789")?

  // Test very large positive number
  let a = from_hex(
    "123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  check_len(a)?
  inspect(
    a.to_string(),
    content="35365207917649046390549507392234216535182073572857507984542859337680634154115797374584",
  )?
  let a = from_hex(
    "11E3444DC1F35F057AD2CBC2791737468140A426FAC3CBA7AF8C92A8F34E",
  )
  check_len(a)?
  inspect(
    a.to_string(),
    content="123456789012345678123456789012345678123456789012345678123456789012345678",
  )?
  let a = from_hex(
    "805146F2F58580962A0A2E6134BC75E25AD97AE3D09CD34BA4F629AB8911F3F5CB8573A62EDD16B0D46775A415F545A75518DA3439914D9CAA26449067D85E704E8FCF9B29182485B41F952616BACDFDDF52B413B524D0EB743E8264A9C6AE32D12C3D20C5B81189060F4AC5D216713D503A69644EA8E4EA220A720C41F6B3D18BED65B4238318E6B0A41D8540D756865EC92DF40E8D365A230F17DF1D0A440BC6A557CD46D00B10D74C0E75500B2ADB3A0336223F9285B78CD04F485E417E1DB562B9EFCF79433209E6D6E2F43A484E471DE4F1F5AE38E08E7DAEB644C2C0A22697DD6D29BE0B40FF50DB575FEF02FA5525953C7C198B4A3600BA8CE1F917852A4B957151189F09DCDFCB79963E7D850127858A97855B94870ACCBE8203E73FE79791EE6EA1B1282A0CEAC54D6F6B7CD6C7B8D8092E949FF0A84",
  )
  check_len(a)?
  inspect(
    a.to_string(),
    content="12345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812",
  )?

  // Test very large negative number
  let a = from_hex(
    "-123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  check_len(a)?
  inspect(
    a.to_string(),
    content="-35365207917649046390549507392234216535182073572857507984542859337680634154115797374584",
  )?
}

test "to_hex" {
  // Check zero
  let a = from_hex("00")
  check_len(a)?
  inspect(a.to_hex(), content="0")?

  // Test negative number
  let a = from_hex("-F")
  check_len(a)?
  inspect(a.to_hex(), content="-F")?

  // Test positive number
  let a = from_hex("F")
  check_len(a)?
  inspect(a.to_hex(), content="F")?

  // Test positive number with leading zero
  let a = from_hex("10")
  check_len(a)?
  inspect(a.to_hex(), content="10")?

  // Test large positive number
  let a = from_hex("01234567890123456789")
  check_len(a)?
  inspect(a.to_hex(), content="1234567890123456789")?

  // Check padding
  let a = from_hex("100000")
  check_len(a)?
  inspect(a.to_string(), content="1048576")?
  inspect(a.to_hex(), content="100000")?

  // Test very large positive number
  let a = from_string(
    "123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  check_len(a)?
  inspect(
    a.to_hex(),
    content="11E3444DC1F35F057AD2CBC2791737468140A426FAC3CBA7AF8C92A8F34E",
  )?
  let a = from_string(
    "35365207917649046390549507392234216535182073572857507984542859337680634154115797374584",
  )
  check_len(a)?
  inspect(
    a.to_hex(),
    content="123456789012345678123456789012345678123456789012345678123456789012345678",
  )?
  let str = "12345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812345678901234567812"
  let a = from_string(str)
  check_len(a)?
  inspect(
    a.to_hex(),
    content="805146F2F58580962A0A2E6134BC75E25AD97AE3D09CD34BA4F629AB8911F3F5CB8573A62EDD16B0D46775A415F545A75518DA3439914D9CAA26449067D85E704E8FCF9B29182485B41F952616BACDFDDF52B413B524D0EB743E8264A9C6AE32D12C3D20C5B81189060F4AC5D216713D503A69644EA8E4EA220A720C41F6B3D18BED65B4238318E6B0A41D8540D756865EC92DF40E8D365A230F17DF1D0A440BC6A557CD46D00B10D74C0E75500B2ADB3A0336223F9285B78CD04F485E417E1DB562B9EFCF79433209E6D6E2F43A484E471DE4F1F5AE38E08E7DAEB644C2C0A22697DD6D29BE0B40FF50DB575FEF02FA5525953C7C198B4A3600BA8CE1F917852A4B957151189F09DCDFCB79963E7D850127858A97855B94870ACCBE8203E73FE79791EE6EA1B1282A0CEAC54D6F6B7CD6C7B8D8092E949FF0A84",
  )?

  // Test very large negative number
  let a = from_string(
    "-123456789012345678123456789012345678123456789012345678123456789012345678",
  )
  check_len(a)?
  inspect(
    a.to_hex(),
    content="-11E3444DC1F35F057AD2CBC2791737468140A426FAC3CBA7AF8C92A8F34E",
  )?
}

// Copyright 2024 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

test "default" {
  inspect!(@string.default())
}

test "compare" {
  assert_eq!(0, "".compare(""))
  assert_eq!(-1, "".compare("abc"))
  assert_eq!(1, "abc".compare(""))
  assert_eq!(-1, "abcd".compare("abce"))
  assert_eq!(1, "abce".compare("abcd"))
  assert_eq!(-1, "c".compare("ab"))
  assert_eq!(1, "ab".compare("c"))
}

test "to_bytes" {
  assert_eq!("ä¸­æ–‡".to_bytes().to_string(), "ä¸­æ–‡")
  assert_eq!("asdf".to_bytes().to_string(), "asdf")
  assert_eq!("ğŸ¤£ğŸ¤£".to_bytes().to_string(), "ğŸ¤£ğŸ¤£")
  assert_eq!("ğŸ¤”".to_bytes().to_string(), "ğŸ¤”")
}

test "Show::output" {
  fn repr(s : String) {
    let buf = Buffer::new(size_hint=0)
    s |> Show::output(buf)
    buf.to_string()
  }

  assert_eq!(repr("a"), "\"a\"")
  assert_eq!(repr("'"), "\"'\"")
  assert_eq!(repr("\""), "\"\\\"\"")
  assert_eq!(repr("\\"), "\"\\\\\"")
  assert_eq!(repr("\n"), "\"\\n\"")
  assert_eq!(repr("\r"), "\"\\r\"")
  assert_eq!(repr("\b"), "\"\\b\"")
  assert_eq!(repr("\t"), "\"\\t\"")
  assert_eq!(repr("\x00"), "\"\\x00\"")
  assert_eq!(repr("abc'\"def\\"), "\"abc'\\\"def\\\\\"")
}

test "to_array" {
  let a = "ä½ å¥½ï¼mbtğŸ˜€".to_array()
  inspect!(a[0], content="'ä½ '")
  inspect!(a[1], content="'å¥½'")
  inspect!(a[2], content="'ï¼'")
  inspect!(a[3], content="'m'")
  inspect!(a[4], content="'b'")
  inspect!(a[5], content="'t'")
  inspect!(a[6], content="'ğŸ˜€'")
}

test "substring" {
  assert_eq!("abc".substring(), "abc")
  assert_eq!("abc".substring(start=1), "bc")
  assert_eq!("abc".substring(end=2), "ab")
  assert_eq!("abc".substring(start=1, end=2), "b")
}

test "chars" {
  let mut str = ""
  "AğŸ˜Šğ ®·BAğŸ˜Šğ ®·B"
  .iter()
  .each(fn(c) { str = str + c.to_int().to_string() + "\n" })
  inspect!(
    str,
    content=
      #|65
      #|128522
      #|134071
      #|66
      #|65
      #|128522
      #|134071
      #|66
      #|
    ,
  )
  inspect!(
    "AğŸ˜Šğ ®·BAğŸ˜Šğ ®·B".iter().take(2).collect(),
    content="['A', 'ğŸ˜Š']",
  )
  inspect!(
    "AğŸ˜Šğ ®·BAğŸ˜Šğ ®·B".iter().take(4).collect(),
    content="['A', 'ğŸ˜Š', 'ğ ®·', 'B']",
  )
}

test "rev_iter" {
  let mut str = ""
  "AğŸ˜Šğ ®·BAğŸ˜Šğ ®·B"
  .rev_iter()
  .each(fn(c) { str = str + c.to_int().to_string() + "\n" })
  inspect!(
    str,
    content=
      #|66
      #|134071
      #|128522
      #|65
      #|66
      #|134071
      #|128522
      #|65
      #|
    ,
  )
  inspect!(
    "AğŸ˜Šğ ®·BAğŸ˜Šğ ®·B".rev_iter().take(2).collect(),
    content="['B', 'ğ ®·']",
  )
  inspect!(
    "AğŸ˜Šğ ®·BAğŸ˜Šğ ®·B".rev_iter().take(4).collect(),
    content="['B', 'ğ ®·', 'ğŸ˜Š', 'A']",
  )
}

test "iter2" {
  let mut str = ""
  "AğŸ˜Šğ ®·BAğŸ˜Šğ ®·B"
  .iter2()
  .each(fn(i, c) { str = str + "\{i}: \{c.to_int()} \n" })
  inspect!(
    str,
    content=
      #|0: 65 
      #|1: 128522 
      #|2: 134071 
      #|3: 66 
      #|4: 65 
      #|5: 128522 
      #|6: 134071 
      #|7: 66 
      #|
    ,
  )
}

// test here to avlid cyclic dependency between assertion and builtin
test "Buffer::to_bytes" {
  let buffer = Buffer::new(size_hint=16)
  buffer.write_string("ä¸­æ–‡")
  assert_eq!(buffer.to_bytes().to_string(), "ä¸­æ–‡")
}

test "panic substring_start_index_error" {
  "test".substring(start=-1, end=0) |> ignore
}

test "panic substring_end_index_error" {
  "test".substring(start=0, end=-1) |> ignore
}

test "panic substring_start_end_index_error" {
  "test".substring(start=1, end=0) |> ignore
}

test "panic substring_length_index_error" {
  "test".substring(start=0, end=5) |> ignore
}

test "trim_left" {
  inspect!("aaabcd".trim_left("a"), content="bcd")
  inspect!("aaabcd".trim_left(" "), content="aaabcd")
  inspect!("aaabcd".trim_left(""), content="aaabcd")
  inspect!("  abc".trim_left(" "), content="abc")
  inspect!(
    "å“‡ä½ å¥½æœˆå…”ä½ å¥½å“‡".trim_left("ä½ å¥½å“‡"),
    content="æœˆå…”ä½ å¥½å“‡",
  )
  inspect!("ğŸ˜ğŸ˜ğŸ˜­ğŸ˜¡ğŸ˜¡".trim_left("ğŸ˜"), content="ğŸ˜­ğŸ˜¡ğŸ˜¡")
}

test "trim_right" {
  inspect!("abcddd".trim_right("d"), content="abc")
  inspect!("abcddd".trim_right(" "), content="abcddd")
  inspect!("abcddd".trim_right(""), content="abcddd")
  inspect!("abc  ".trim_right(" "), content="abc")
  inspect!(
    "å“‡ä½ å¥½æœˆå…”ä½ å¥½å“‡".trim_right("ä½ å¥½å“‡"),
    content="å“‡ä½ å¥½æœˆå…”",
  )
  inspect!("ğŸ˜ğŸ˜ğŸ˜­ğŸ˜¡ğŸ˜¡".trim_right("ğŸ˜¡"), content="ğŸ˜ğŸ˜ğŸ˜­")
}

test "trim" {
  inspect!("xxxabcxxx".trim("x"), content="abc")
  inspect!("xxxabcxxx".trim(""), content="xxxabcxxx")
  inspect!("å“‡ä½ å¥½æœˆå…”ä½ å¥½å“‡".trim("ä½ å¥½å“‡"), content="æœˆå…”")
  inspect!("\n\r\t abc \n\r\t".trim(" \n\r\t"), content="abc")
  inspect!("=-wow-=".trim("-="), content="wow")
  inspect!("ğŸ˜ğŸ˜ğŸ˜­ğŸ˜¡ğŸ˜¡".trim("ğŸ˜ğŸ˜¡"), content="ğŸ˜­")
}

test "trim_space" {
  inspect!(" abc ".trim_space(), content="abc")
  inspect!("abc ".trim_space(), content="abc")
  inspect!(" abc".trim_space(), content="abc")
  inspect!("\nabc\n".trim_space(), content="abc")
  inspect!("\tabc\t".trim_space(), content="abc")
  inspect!("\rabc\r".trim_space(), content="abc")
  inspect!("abc".trim_space(), content="abc")
  inspect!("".trim_space(), content="")
  inspect!("  ".trim_space(), content="")
  inspect!("\n\n".trim_space(), content="")
  inspect!("\t\t".trim_space(), content="")
  inspect!("\r\r".trim_space(), content="")
}

test "is_empty" {
  inspect!("".is_empty(), content="true")
  inspect!(" ".is_empty(), content="false")
  inspect!("\n".is_empty(), content="false")
  inspect!("\r".is_empty(), content="false")
  inspect!("\t".is_empty(), content="false")
  inspect!("a".is_empty(), content="false")
}

test "is_blank" {
  inspect!("".is_blank(), content="true")
  inspect!(" ".is_blank(), content="true")
  inspect!("\n".is_blank(), content="true")
  inspect!("\r".is_blank(), content="true")
  inspect!("\t".is_blank(), content="true")
  inspect!("a".is_blank(), content="false")
}

test "index_of" {
  inspect!("abc".index_of("a"), content="0")
  inspect!("abc".index_of("b"), content="1")
  inspect!("abc".index_of("c"), content="2")
  inspect!("abc".index_of("ab"), content="0")
  inspect!("abc".index_of("bc"), content="1")
  inspect!("abc".index_of(""), content="0")
  inspect!("abc".index_of("d"), content="-1")
  inspect!("abc".index_of("abcd"), content="-1")
  inspect!("ä½ å¥½æœˆå…”".index_of("ä½ "), content="0")
  inspect!("ä½ å¥½æœˆå…”".index_of("å¥½"), content="1")
  inspect!("ä½ å¥½æœˆå…”".index_of("æœˆ"), content="2")
  inspect!("ä½ å¥½æœˆå…”".index_of("å…”"), content="3")
  inspect!("ä½ å¥½æœˆå…”".index_of("æ—¥"), content="-1")
  inspect!("ğŸ˜ğŸ˜­ğŸ˜¡".index_of("ğŸ˜"), content="0")
  inspect!("ğŸ˜ğŸ˜­ğŸ˜¡".index_of("ğŸ˜­"), content="2")
  inspect!("ğŸ˜ğŸ˜­ğŸ˜¡".index_of("ğŸ˜¡"), content="4")
  inspect!("ğŸ˜ğŸ˜­ğŸ˜¡".index_of("ğŸ˜"), content="-1")
  inspect!("".index_of("a"), content="-1")
  inspect!("".index_of(""), content="0")
  inspect!("abc".index_of("b", from=-1), content="1")
  inspect!("abc".index_of("b", from=0), content="1")
  inspect!("abc".index_of("b", from=1), content="1")
  inspect!("abc".index_of("b", from=2), content="-1")
  inspect!("abc".index_of("b", from=3), content="-1")
  inspect!("abc".index_of("b", from=100), content="-1")
}

test "last_index_of" {
  inspect!("abc".last_index_of("a"), content="0")
  inspect!("abc".last_index_of("b"), content="1")
  inspect!("abc".last_index_of("c"), content="2")
  inspect!("abc".last_index_of("d"), content="-1")
  inspect!("abc".last_index_of(""), content="3")
  inspect!("abcabc".last_index_of("ab"), content="3")
  inspect!("abcabc".last_index_of("ca"), content="2")
  inspect!("abcabc".last_index_of("cb"), content="-1")
  inspect!("abcabc".last_index_of("d"), content="-1")
  inspect!("abcabc".last_index_of(""), content="6")
  inspect!("ä½ å¥½æœˆå…”ä½ å¥½æœˆå…”".last_index_of("ä½ "), content="4")
  inspect!("ä½ å¥½æœˆå…”ä½ å¥½æœˆå…”".last_index_of("å¥½"), content="5")
  inspect!("ä½ å¥½æœˆå…”ä½ å¥½æœˆå…”".last_index_of("æœˆ"), content="6")
  inspect!("ä½ å¥½æœˆå…”ä½ å¥½æœˆå…”".last_index_of("å…”"), content="7")
  inspect!("ä½ å¥½æœˆå…”ä½ å¥½æœˆå…”".last_index_of("æ—¥"), content="-1")
  inspect!("ğŸ˜ğŸ˜­ğŸ˜¡ğŸ˜ğŸ˜­ğŸ˜¡".last_index_of("ğŸ˜"), content="6")
  inspect!("ğŸ˜ğŸ˜­ğŸ˜¡ğŸ˜ğŸ˜­ğŸ˜¡".last_index_of("ğŸ˜­"), content="8")
  inspect!("ğŸ˜ğŸ˜­ğŸ˜¡ğŸ˜ğŸ˜­ğŸ˜¡".last_index_of("ğŸ˜¡"), content="10")
  inspect!("ğŸ˜ğŸ˜­ğŸ˜¡ğŸ˜ğŸ˜­ğŸ˜¡".last_index_of("ğŸ˜"), content="-1")
  inspect!("".last_index_of("a"), content="-1")
  inspect!("".last_index_of(""), content="0")
  inspect!("abc".last_index_of("b", from=-1), content="-1")
  inspect!("abc".last_index_of("b", from=0), content="-1")
  inspect!("abc".last_index_of("b", from=1), content="-1")
  inspect!("abc".last_index_of("b", from=2), content="1")
  inspect!("abc".last_index_of("b", from=3), content="1")
  inspect!("abc".last_index_of("b", from=100), content="1")
}

test "starts_with" {
  inspect!("abc".starts_with("a"), content="true")
  inspect!("abc".starts_with("ab"), content="true")
  inspect!("abc".starts_with("abc"), content="true")
  inspect!("abc".starts_with("abcd"), content="false")
  inspect!("abc".starts_with("b"), content="false")
  inspect!("abc".starts_with(""), content="true")
  inspect!("ä½ å¥½æœˆå…”".starts_with("ä½ å¥½"), content="true")
  inspect!("ä½ å¥½æœˆå…”".starts_with("æœˆå…”"), content="false")
  inspect!("ğŸ˜ğŸ˜­ğŸ˜¡".starts_with("ğŸ˜"), content="true")
  inspect!("ğŸ˜ğŸ˜­ğŸ˜¡".starts_with("ğŸ˜­"), content="false")
  inspect!("".starts_with(""), content="true")
  inspect!("".starts_with("a"), content="false")
}

test "ends_with" {
  inspect!("abc".ends_with("c"), content="true")
  inspect!("abc".ends_with("bc"), content="true")
  inspect!("abc".ends_with("abc"), content="true")
  inspect!("abc".ends_with("d"), content="false")
  inspect!("abc".ends_with("ab"), content="false")
  inspect!("abc".ends_with("abcd"), content="false")
  inspect!("abc".ends_with(""), content="true")
  inspect!("ä½ å¥½æœˆå…”".ends_with("ä½ å¥½"), content="false")
  inspect!("ä½ å¥½æœˆå…”".ends_with("æœˆå…”"), content="true")
  inspect!("ğŸ˜ğŸ˜­ğŸ˜¡".ends_with("ğŸ˜­"), content="false")
  inspect!("ğŸ˜ğŸ˜­ğŸ˜¡".ends_with("ğŸ˜¡"), content="true")
  inspect!("".ends_with(""), content="true")
  inspect!("".ends_with("a"), content="false")
}

test "split" {
  inspect!(
    "a,b,c,d,e".split(","),
    content=
      #|["a", "b", "c", "d", "e"]
    ,
  )
  inspect!(
    "abcde".split(""),
    content=
      #|["a", "b", "c", "d", "e"]
    ,
  )
  inspect!(
    "a b c d e".split(" "),
    content=
      #|["a", "b", "c", "d", "e"]
    ,
  )
  inspect!(
    "abcde".split("x"),
    content=
      #|["abcde"]
    ,
  )
  inspect!("".split(""), content="[]")
  inspect!("".split("x"), content="[]")
  inspect!(
    "ä½  wow å¥½ wow æœˆ wow å…”".split(" wow "),
    content=
      #|["ä½ ", "å¥½", "æœˆ", "å…”"]
    ,
  )
  inspect!(
    "ğŸ‘ğŸ˜ğŸ˜­ğŸ‘ğŸ˜ğŸ˜­ğŸ‘ğŸ˜ğŸ˜­ğŸ‘".split("ğŸ˜ğŸ˜­"),
    content=
      #|["ğŸ‘", "ğŸ‘", "ğŸ‘", "ğŸ‘"]
    ,
  )
}

test "replace" {
  inspect!("abcabc".replace(old="b", new="x"), content="axcabc")
  inspect!("abcabc".replace(old="", new=","), content=",abcabc")
  inspect!("a b c".replace(old=" ", new=","), content="a,b c")
  inspect!("abcabc".replace(old="x", new="a"), content="abcabc")
  inspect!(
    "ä½ å¥½æœˆå…”".replace(old="æœˆå…”", new="Moonbit"),
    content="ä½ å¥½Moonbit",
  )
  inspect!("ğŸ‘ğŸ˜ğŸ˜­".replace(old="ğŸ˜ğŸ˜­", new=""), content="ğŸ‘")
}

test "replace_all" {
  inspect!("abcabc".replace_all(old="b", new="x"), content="axcaxc")
  inspect!("abcabc".replace_all(old="", new=","), content=",a,b,c,a,b,c,")
  inspect!("a b c".replace_all(old=" ", new=","), content="a,b,c")
  inspect!("".replace_all(old="", new="x"), content="x")
  inspect!(
    "ä½ å¥½æœˆå…”ï¼Œæœˆå…”ä½ å¥½".replace_all(old="æœˆå…”", new="Moonbit"),
    content="ä½ å¥½Moonbitï¼ŒMoonbitä½ å¥½",
  )
  inspect!(
    "ğŸ‘ğŸ˜ğŸ˜­ğŸ‘ğŸ˜ğŸ˜­ğŸ‘ğŸ˜ğŸ˜­ğŸ‘".replace_all(
      old="ğŸ˜ğŸ˜­",
      new="",
    ),
    content="ğŸ‘ğŸ‘ğŸ‘ğŸ‘",
  )
}

test "reverse" {
  inspect!("hello".rev(), content="olleh")
  inspect!("Nothing".rev(), content="gnihtoN")
  inspect!("< >".rev(), content="> <")
}

test "to_lower" {
  inspect!("ABCXYZ".to_lower(), content="abcxyz")
  inspect!("aBcXyZ".to_lower(), content="abcxyz")
  inspect!("".to_lower(), content="")
  inspect!(" ".to_lower(), content=" ")
  inspect!("æœˆå…”".to_lower(), content="æœˆå…”")
}

test "to_upper" {
  inspect!("abcxyz".to_upper(), content="ABCXYZ")
  inspect!("AbCxYz".to_upper(), content="ABCXYZ")
  inspect!("".to_upper(), content="")
  inspect!(" ".to_upper(), content=" ")
  inspect!("æœˆå…”".to_upper(), content="æœˆå…”")
}

test "split" {
  inspect!(
    "a b c d e".split(" "),
    content=
      #|["a", "b", "c", "d", "e"]
    ,
  )
  inspect!(
    "abcde".split("x"),
    content=
      #|["abcde"]
    ,
  )
  inspect!("".split(""), content="[]")
  inspect!("".split("x"), content="[]")
  inspect!(
    "ä½  wow å¥½ wow æœˆ wow å…”".split(" wow "),
    content=
      #|["ä½ ", "å¥½", "æœˆ", "å…”"]
    ,
  )
  inspect!(
    "ğŸ‘ğŸ˜ğŸ˜­ğŸ‘ğŸ˜ğŸ˜­ğŸ‘ğŸ˜ğŸ˜­ğŸ‘".split("ğŸ˜ğŸ˜­"),
    content=
      #|["ğŸ‘", "ğŸ‘", "ğŸ‘", "ğŸ‘"]
    ,
  )
  // Additional test cases
  inspect!(
    "a,b,c,d,e".split(","),
    content=
      #|["a", "b", "c", "d", "e"]
    ,
  )
  inspect!(
    "a,,b,,c".split(","),
    content=
      #|["a", "", "b", "", "c"]
    ,
  )
  inspect!(
    "a,,b,,c".split(",,"),
    content=
      #|["a", "b", "c"]
    ,
  )
  inspect!(
    "a b c d e".split(""),
    content=
      #|["a", " ", "b", " ", "c", " ", "d", " ", "e"]
    ,
  )
  inspect!(
    "a b c d e".split(" "),
    content=
      #|["a", "b", "c", "d", "e"]
    ,
  )
}

test "String::fold" {
  let s = "this is a long string"
  inspect!(s.fold(init=0, fn(acc, c) { acc + c.to_int() }), content="1980")
  inspect!(
    s.fold(init=@list.Nil, @list.add) |> @list.rev(),
    content="@list.of(['t', 'h', 'i', 's', ' ', 'i', 's', ' ', 'a', ' ', 'l', 'o', 'n', 'g', ' ', 's', 't', 'r', 'i', 'n', 'g'])",
  )
  inspect!(
    s.rev_fold(init=@list.Nil, @list.add),
    content="@list.of(['t', 'h', 'i', 's', ' ', 'i', 's', ' ', 'a', ' ', 'l', 'o', 'n', 'g', ' ', 's', 't', 'r', 'i', 'n', 'g'])",
  )
}

test "pad_left" {
  inspect!("2".pad_start(3, '0'), content="002")
  inspect!("22".pad_start(2, '0'), content="22")
  inspect!("5".pad_start(4, 'x'), content="xxx5")
}

test "pad_right" {
  inspect!("2".pad_end(3, 'x'), content="2xx")
  inspect!("22".pad_end(2, '0'), content="22")
  inspect!("5".pad_end(4, 'x'), content="5xxx")
}

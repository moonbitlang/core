#!/bin/bash

# Pre-commit hook to ensure code quality with MoonBit
# This hook runs `moon check` to validate the code before allowing commits

set -e

echo "üåô Running MoonBit pre-commit checks..."

# Check if moon is available
if ! command -v moon &> /dev/null; then
    echo "‚ùå Error: 'moon' command not found. Please install MoonBit toolchain."
    echo "   Visit: https://www.moonbitlang.com/download/"
    exit 1
fi

# Run moon check and capture output
echo "üìã Running 'moon check'..."
CHECK_OUTPUT=$(moon check 2>&1)
CHECK_EXIT_CODE=$?

if [ $CHECK_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "‚ùå Pre-commit hook failed!"
    echo "   'moon check' found issues in your code:"
    echo ""
    echo "üìù Error details:"
    echo "$CHECK_OUTPUT" | sed 's/^/   /'
    echo ""
    echo "üí° Common fixes:"
    echo "   - Run 'moon fmt' to auto-format your code"
    echo "   - Check for type errors and fix them"
    echo "   - Ensure all imports are valid"
    echo "   - Review the error messages above for specific issues"
    exit 1
else
    echo "   $CHECK_OUTPUT"
fi

echo "‚úÖ All checks passed! Proceeding with commit..."
echo ""
